################################################################################
#                                                                              #
#                   CASEGEN - PIPELINE STEP-BY-STEP TESTING                   #
#                                                                              #
#  Este arquivo permite testar cada etapa do pipeline de gera√ß√£o de casos     #
#  de forma isolada e sequencial. √ötil para debug e desenvolvimento.          #
#                                                                              #
#  FLUXO COMPLETO:                                                             #
#  1. PlanStepOnly        ‚Üí Cria caso + gera plano                            #
#  2. ExpandStepByCaseId  ‚Üí Expande detalhes (suspeitos, evid√™ncias, etc)    #
#  3. DesignStepByCaseId  ‚Üí Design de documentos e m√≠dias                     #
#  4. GenerateStepByCaseId ‚Üí Gera conte√∫do final (textos/imagens)            #
#  5. NormalizeStepByCaseId ‚Üí Normaliza e finaliza caso                       #
#                                                                              #
################################################################################

@baseUrl = http://localhost:7071

# ‚ö†Ô∏è IMPORTANTE: Atualize este caseId ap√≥s executar o Step 1 (PlanStepOnly)
@caseId = CASE-20251118-cab70d1f
@planInstanceId = fc65ae2486f34222b38026633a99e98a
@expandInstanceId = 0d4eb8cd4c224aba87eeeb2d283fa363
@designInstanceId = 9b169946f653478fbf2d00e6c50bd800
@generateInstanceId = 4e1344279cab4012aed26d0bfc23b41e
@normalizeInstanceId = 8c91f9d7e8b04de08ec1fdfd87449f79

################################################################################
# üìù STEP 1: PLAN - Criar caso e gerar plano inicial
################################################################################
# Cria um novo caso e executa apenas a etapa de planejamento de forma ass√≠ncrona (Durable).
# Retorna: 202 Accepted + caseId + instanceId (use caseId nos pr√≥ximos steps e o instanceId para checar status!)
# Dura√ß√£o: ~30-60 segundos (monitora√ß√£o via PlanStepStatus)
# Storage: Salva plan.json no blob

### STEP 1A - Plan para caso Rookie (f√°cil)
POST {{baseUrl}}/api/PlanStepOnly
Content-Type: application/json

{
  "difficulty": "Rookie",
  "timezone": "America/Toronto"
}

### STEP 1-STATUS - Verificar status do Plan (Durable)
# Atualize @planInstanceId com o valor retornado pelo Step 1
GET {{baseUrl}}/api/PlanStepStatus/{{planInstanceId}}


################################################################################
# üîç STEP 2: EXPAND - Expandir detalhes do caso
################################################################################
# Busca o plan.json do storage e expande os detalhes (agora via Durable Functions):
#   - Suspeitos (perfis detalhados)
#   - Evid√™ncias (descri√ß√µes completas)
#   - Timeline (sequ√™ncia de eventos)
#   - Testemunhas
# Retorno: 202 Accepted + instanceId; monitore com STEP 2-STATUS
# Dura√ß√£o: ~60-90 segundos (acompanhe via status)
# Storage: Salva expand/*.json (suspects, evidence, timeline, witnesses)

### STEP 2 - Expand (use o caseId do Step 1)
POST {{baseUrl}}/api/ExpandStepByCaseId
Content-Type: application/json

{
  "caseId": "{{caseId}}"
}

### STEP 2-STATUS - Verificar status do Expand (Durable)
# Atualize @expandInstanceId com o valor retornado pelo Step 2
GET {{baseUrl}}/api/ExpandStepStatus/{{expandInstanceId}}


################################################################################
# üé® STEP 3: DESIGN - Design de documentos e m√≠dias
################################################################################
# Busca plan.json e expand/*.json do storage e cria o design (Durable Functions):
#   - Cat√°logo de documentos (relat√≥rios, entrevistas, etc)
#   - Cat√°logo de m√≠dias (fotos, v√≠deos, √°udios)
#   - Especifica√ß√µes visuais
#   - Estrutura narrativa
# Retorno: 202 Accepted + instanceId; monitore com STEP 3-STATUS
# Dura√ß√£o: ~90-120 segundos (acompanhe via status)
# Storage: Salva design/*.json (documents, media, specs)

### STEP 3 - Design (use o caseId dos steps anteriores)
POST {{baseUrl}}/api/DesignStepByCaseId
Content-Type: application/json

{
  "caseId": "{{caseId}}"
}

### STEP 3-STATUS - Verificar status do Design (Durable)
# Atualize @designInstanceId com o valor retornado pelo Step 3
GET {{baseUrl}}/api/DesignStepStatus/{{designInstanceId}}


################################################################################
# ‚ú® STEP 4: GENERATE - Gerar conte√∫do final (Durable)
################################################################################
# Busca design.json do storage, gera documentos e m√≠dias em fan-out paralelo e
# grava os arquivos do caso em `cases/{caseId}/generate/*`.
# Retorno: 202 Accepted + instanceId; monitore com STEP 4-STATUS. A execu√ß√£o
# pode durar v√°rios minutos (cada documento leva 2-3 minutos, mas agora roda em
# paralelo com Durables e sem timeouts HTTP).
# ‚Ä¢ `generateImages: true` -> al√©m dos metadados JSON, gera os PNGs reais (usa o servi√ßo de imagens)
# ‚Ä¢ `renderFiles: true` -> al√©m dos JSONs, renderiza cada documento em PDF com o motor de templates


### STEP 4 - Generate (use o caseId dos steps anteriores)
POST {{baseUrl}}/api/GenerateStepByCaseId
Content-Type: application/json

{
  "caseId": "{{caseId}}",
  "generateImages": true,
  "renderFiles": false
}

### STEP 4-STATUS - Verificar status do Generate (Durable)
# Atualize @generateInstanceId com o valor retornado pelo Step 4
GET {{baseUrl}}/api/GenerateStepStatus/{{generateInstanceId}}

### STEP 4 - Progress Snapshot (opcional)
# Endpoint auxiliar que inspeciona blobs para ver o que j√° foi gerado
POST {{baseUrl}}/api/GetGenerateProgressByCaseId
Content-Type: application/json

{
  "caseId": "{{caseId}}"
}


################################################################################
# üéØ STEP 5: NORMALIZE - Normalizar e finalizar caso
################################################################################
# Busca todos os dados gerados e executa normaliza√ß√£o final via Durable:
#   - Valida√ß√£o de integridade + QA iterativo
#   - Ajustes de formata√ß√£o e consist√™ncia
#   - Gera√ß√£o da cole√ß√£o final (bundle + manifest)
#   - Empacotamento dos arquivos finais
# Configure timezone/difficulty/maxQaIterations conforme o cen√°rio.
# Dura√ß√£o: ~2-4 minutos (acompanhe via STEP 5-STATUS)
# Storage: Salva bundle final compactado em cases/{caseId}/normalize/

### STEP 5 - Normalize (finaliza o caso)
POST {{baseUrl}}/api/NormalizeStepByCaseId
Content-Type: application/json

{
  "caseId": "{{caseId}}",
  "timezone": "America/Toronto",
  "difficulty": "Detective",
  "maxQaIterations": 3
}

### STEP 5-STATUS - Verificar status do Normalize (Durable)
# Atualize @normalizeInstanceId com o valor retornado pelo Step 5
GET {{baseUrl}}/api/NormalizeStepStatus/{{normalizeInstanceId}}


################################################################################
# üìä EXEMPLOS DE FLUXOS COMPLETOS
################################################################################

### FLUXO 1: Desenvolvimento R√°pido (sem imagens)
# 1. Execute STEP 1A (Plan Rookie)
# 2. Copie o caseId retornado e atualize @caseId no topo do arquivo
# 3. Execute STEP 2 (Expand)
# 4. Execute STEP 3 (Design)
# 5. Execute STEP 4 (Generate com generateImages=false/renderFiles=false)
# 6. Execute STEP 5 (Normalize)
# Tempo total: ~4-6 minutos

### FLUXO 2: Produ√ß√£o com Imagens
# 1. Execute STEP 1 ajustando o body para difficulty "Detective"
# 2. Atualize @caseId
# 3. Execute STEP 2 ‚Üí 3 ‚Üí 4 (com generateImages/renderFiles conforme necess√°rio) ‚Üí 5
# Tempo total: ~18-30 minutos

### FLUXO 3: Debug de Etapa Espec√≠fica
# Se voc√™ quer apenas re-executar o Expand de um caso existente:
# 1. Atualize @caseId com um caso que j√° tem plan.json
# 2. Execute apenas STEP 2
# O sistema busca o plan existente e reprocessa apenas o Expand

################################################################################
# üí° DICAS
################################################################################
# 
# ‚Ä¢ Use vari√°veis de ambiente (@caseId) para evitar copy/paste
# ‚Ä¢ Cada step √© independente e pode ser re-executado
# ‚Ä¢ √ötil para testar mudan√ßas incrementais em cada etapa
# ‚Ä¢ Logs detalhados em cada endpoint mostram tempo e tokens
# ‚Ä¢ Storage √© preservado entre execu√ß√µes
#
################################################################################




##TEMP GENERATE DOCS
POST http://localhost:7071/api/TempRenderDocument?code=<function-key>
Content-Type: application/json

{
  "blobPath": "bundles/CASE-20251118-cab70d1f/documents/doc_kiosk_aw17_006.json"
}