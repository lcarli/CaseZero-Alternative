name: 🤖 Deploy Case Generator Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy Case Generator infrastructure to'
        required: true
        type: choice
        options:
        - development
        - production
      action:
        description: 'Action to perform'
        required: true
        type: choice
        default: 'deploy'
        options:
        - deploy
        - validate
        - destroy
      confirm_destroy:
        description: 'Type "CONFIRM" to destroy resources (required for destroy action)'
        required: false
        default: ''

env:
  AZURE_RESOURCE_GROUP_DEV: casezero-casegen-dev-rg
  AZURE_RESOURCE_GROUP_PROD: casezero-casegen-prod-rg
  BICEP_FILE_PATH: infrastructure/bicep/case-generator.bicep

jobs:
  validate-inputs:
    name: ✅ Validate Inputs
    runs-on: ubuntu-latest
    
    steps:
      - name: 🔍 Validate destroy confirmation
        if: github.event.inputs.action == 'destroy'
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "CONFIRM" ]; then
            echo "❌ Destroy action requires typing 'CONFIRM' in the confirmation field"
            exit 1
          fi
          echo "✅ Destroy action confirmed"

  validate-bicep:
    name: 🔍 Validate BICEP Templates
    runs-on: ubuntu-latest
    needs: [validate-inputs]
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ github.event.inputs.environment == 'production' && secrets.AZURE_CREDENTIALS_PROD || secrets.AZURE_CREDENTIALS_DEV }}

      - name: 🔍 Validate BICEP syntax
        run: |
          echo "Validating Case Generator BICEP template syntax..."
          az bicep build --file ${{ env.BICEP_FILE_PATH }}

      - name: 🔍 Validate deployment template
        run: |
          RESOURCE_GROUP="${{ github.event.inputs.environment == 'production' && env.AZURE_RESOURCE_GROUP_PROD || env.AZURE_RESOURCE_GROUP_DEV }}"
          PARAMS_FILE="infrastructure/bicep/case-generator-parameters.${{ github.event.inputs.environment == 'production' && 'prod' || 'dev' }}.json"
          
          echo "Validating Case Generator deployment to resource group: $RESOURCE_GROUP"
          
          # Create resource group if it doesn't exist
          # az group create --name $RESOURCE_GROUP --location "canadaeast" --tags Environment=${{ github.event.inputs.environment }} Project=CaseZero Component=CaseGenerator ManagedBy=GitHub-Actions
          
          # Validate the deployment
          # az deployment group validate \
            --resource-group $RESOURCE_GROUP \
            --template-file ${{ env.BICEP_FILE_PATH }} \
            --parameters @$PARAMS_FILE

      - name: 📊 Generate What-If Analysis
        if: github.event.inputs.action != 'validate'
        run: |
          RESOURCE_GROUP="${{ github.event.inputs.environment == 'production' && env.AZURE_RESOURCE_GROUP_PROD || env.AZURE_RESOURCE_GROUP_DEV }}"
          PARAMS_FILE="infrastructure/bicep/case-generator-parameters.${{ github.event.inputs.environment == 'production' && 'prod' || 'dev' }}.json"
          
          echo "Generating What-If analysis for Case Generator..."
          az deployment group what-if \
            --resource-group $RESOURCE_GROUP \
            --template-file ${{ env.BICEP_FILE_PATH }} \
            --parameters @$PARAMS_FILE \
            --result-format FullResourcePayloads

  deploy-infrastructure:
    name: 🏗️ Deploy Case Generator Infrastructure
    runs-on: ubuntu-latest
    needs: [validate-bicep]
    if: github.event.inputs.action == 'deploy'
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ github.event.inputs.environment == 'production' && secrets.AZURE_CREDENTIALS_PROD || secrets.AZURE_CREDENTIALS_DEV }}

      - name: 🏗️ Deploy Case Generator BICEP Template
        run: |
          RESOURCE_GROUP="${{ github.event.inputs.environment == 'production' && env.AZURE_RESOURCE_GROUP_PROD || env.AZURE_RESOURCE_GROUP_DEV }}"
          PARAMS_FILE="infrastructure/bicep/case-generator-parameters.${{ github.event.inputs.environment == 'production' && 'prod' || 'dev' }}.json"
          DEPLOYMENT_NAME="casezero-casegen-infrastructure-$(date +%Y%m%d%H%M%S)"
          
          echo "Deploying Case Generator infrastructure to: $RESOURCE_GROUP"
          echo "Using parameters file: $PARAMS_FILE"
          echo "Deployment name: $DEPLOYMENT_NAME"
          
          # Deploy the infrastructure
          az deployment group create \
            --resource-group $RESOURCE_GROUP \
            --template-file ${{ env.BICEP_FILE_PATH }} \
            --parameters @$PARAMS_FILE \
            --name $DEPLOYMENT_NAME \
            --verbose

      - name: 📤 Export Deployment Outputs
        id: deployment-outputs
        run: |
          RESOURCE_GROUP="${{ github.event.inputs.environment == 'production' && env.AZURE_RESOURCE_GROUP_PROD || env.AZURE_RESOURCE_GROUP_DEV }}"
          
          echo "Extracting Case Generator deployment outputs..."
          
          # Get the latest deployment
          DEPLOYMENT_NAME=$(az deployment group list --resource-group $RESOURCE_GROUP --query "[0].name" -o tsv)
          
          # Extract outputs
          FUNCTION_APP_NAME=$(az deployment group show --resource-group $RESOURCE_GROUP --name $DEPLOYMENT_NAME --query "properties.outputs.functionAppName.value" -o tsv)
          FUNCTION_APP_URL=$(az deployment group show --resource-group $RESOURCE_GROUP --name $DEPLOYMENT_NAME --query "properties.outputs.functionAppUrl.value" -o tsv)
          STORAGE_NAME=$(az deployment group show --resource-group $RESOURCE_GROUP --name $DEPLOYMENT_NAME --query "properties.outputs.caseGeneratorStorageName.value" -o tsv)
          KEY_VAULT_NAME=$(az deployment group show --resource-group $RESOURCE_GROUP --name $DEPLOYMENT_NAME --query "properties.outputs.keyVaultName.value" -o tsv)
          KEY_VAULT_URI=$(az deployment group show --resource-group $RESOURCE_GROUP --name $DEPLOYMENT_NAME --query "properties.outputs.keyVaultUri.value" -o tsv)
          INSIGHTS_NAME=$(az deployment group show --resource-group $RESOURCE_GROUP --name $DEPLOYMENT_NAME --query "properties.outputs.applicationInsightsName.value" -o tsv)
          
          echo "function-app-name=$FUNCTION_APP_NAME" >> $GITHUB_OUTPUT
          echo "function-app-url=$FUNCTION_APP_URL" >> $GITHUB_OUTPUT
          echo "storage-name=$STORAGE_NAME" >> $GITHUB_OUTPUT
          echo "key-vault-name=$KEY_VAULT_NAME" >> $GITHUB_OUTPUT
          echo "key-vault-uri=$KEY_VAULT_URI" >> $GITHUB_OUTPUT
          echo "insights-name=$INSIGHTS_NAME" >> $GITHUB_OUTPUT

      - name: 🏥 Verify Deployment
        run: |
          echo "Verifying Case Generator deployment..."
          
          # Check if Function App is accessible
          FUNCTION_APP_URL="${{ steps.deployment-outputs.outputs.function-app-url }}"
          
          echo "Function App URL: $FUNCTION_APP_URL"
          
          # Wait a moment for services to start
          sleep 30
          
          # Basic connectivity test
          if curl -f -s -o /dev/null "$FUNCTION_APP_URL"; then
            echo "✅ Case Generator Function App is responding"
          else
            echo "⚠️ Case Generator Function App may not be fully ready yet (this is normal for new deployments)"
          fi

      - name: 📋 Deployment Summary
        run: |
          echo "## 🤖 Case Generator Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ github.event.inputs.environment == 'production' && env.AZURE_RESOURCE_GROUP_PROD || env.AZURE_RESOURCE_GROUP_DEV }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 Case Generator Resources" >> $GITHUB_STEP_SUMMARY
          echo "- **Function App:** ${{ steps.deployment-outputs.outputs.function-app-name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Function App URL:** ${{ steps.deployment-outputs.outputs.function-app-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage Account:** ${{ steps.deployment-outputs.outputs.storage-name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Key Vault:** ${{ steps.deployment-outputs.outputs.key-vault-name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Application Insights:** ${{ steps.deployment-outputs.outputs.insights-name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Function App Plan:** ${{ github.event.inputs.environment == 'production' && 'Premium (EP1)' || 'Consumption (Y1)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage Replication:** ${{ github.event.inputs.environment == 'production' && 'GRS (Geo-Redundant)' || 'LRS (Locally Redundant)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Data Retention:** ${{ github.event.inputs.environment == 'production' && '90 days' || '30 days' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔒 Security Features" >> $GITHUB_STEP_SUMMARY
          echo "- **Managed Identity:** Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- **Key Vault Access:** Configured" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage Access:** Role-based (RBAC)" >> $GITHUB_STEP_SUMMARY
          echo "- **HTTPS Only:** Enforced" >> $GITHUB_STEP_SUMMARY

  destroy-infrastructure:
    name: 🔥 Destroy Case Generator Infrastructure
    runs-on: ubuntu-latest
    needs: [validate-inputs]
    if: github.event.inputs.action == 'destroy'
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: 🔐 Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ github.event.inputs.environment == 'production' && secrets.AZURE_CREDENTIALS_PROD || secrets.AZURE_CREDENTIALS_DEV }}

      - name: 🔥 Delete Case Generator Resource Group
        run: |
          RESOURCE_GROUP="${{ github.event.inputs.environment == 'production' && env.AZURE_RESOURCE_GROUP_PROD || env.AZURE_RESOURCE_GROUP_DEV }}"
          
          echo "⚠️ WARNING: About to delete Case Generator resource group: $RESOURCE_GROUP"
          echo "This action is IRREVERSIBLE and will delete ALL Case Generator resources!"
          
          # Confirm the resource group exists
          if az group exists --name $RESOURCE_GROUP; then
            echo "Resource group $RESOURCE_GROUP exists. Proceeding with deletion..."
            
            # Delete the resource group and all its resources
            az group delete --name $RESOURCE_GROUP --yes --no-wait
            
            echo "🔥 Case Generator resource group deletion initiated. This may take several minutes to complete."
            echo "You can monitor the deletion progress in the Azure Portal."
          else
            echo "Resource group $RESOURCE_GROUP does not exist. Nothing to delete."
          fi

  notify-teams:
    name: 📢 Notify Teams
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, destroy-infrastructure]
    if: always() && (needs.deploy-infrastructure.result != 'skipped' || needs.destroy-infrastructure.result != 'skipped')
    
    steps:
      - name: 📢 Send Teams Notification
        if: always()
        uses: aliencube/microsoft-teams-actions@v0.8.0
        with:
          webhook_uri: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: "🤖 CaseZero Case Generator Infrastructure ${{ github.event.inputs.action == 'destroy' && 'Destroyed' || 'Deployed' }}"
          summary: "Case Generator infrastructure ${{ github.event.inputs.action }} completed"
          text: |
            **Component:** Case Generator Infrastructure
            **Action:** ${{ github.event.inputs.action }}
            **Environment:** ${{ github.event.inputs.environment }}
            **Status:** ${{ (needs.deploy-infrastructure.result == 'success' || needs.destroy-infrastructure.result == 'success') && '✅ Success' || '❌ Failed' }}
            **Triggered by:** ${{ github.actor }}
            **Repository:** ${{ github.repository }}
            
            ${{ github.event.inputs.action == 'deploy' && '🚀 Case Generator infrastructure is ready for Functions deployment!' || '🔥 Case Generator infrastructure has been destroyed.' }}
          theme_color: ${{ (needs.deploy-infrastructure.result == 'success' || needs.destroy-infrastructure.result == 'success') && '00FF00' || 'FF0000' }}
