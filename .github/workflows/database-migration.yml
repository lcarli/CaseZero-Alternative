name: ðŸ—„ï¸ Database Migration & Seed

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run migrations'
        required: true
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Action to perform'
        required: true
        type: choice
        default: 'migrate'
        options:
          - migrate
          - seed
          - migrate-and-seed

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'backend/CaseZeroApi/CaseZeroApi.csproj'

jobs:
  database-migration:
    name: ðŸ—„ï¸ Run Database Migration
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ github.event.inputs.environment == 'prod' && secrets.AZURE_CREDENTIALS_PROD || secrets.AZURE_CREDENTIALS_DEV }}

      - name: ðŸ“¦ Install EF Core Tools
        run: dotnet tool install --global dotnet-ef

      - name: ðŸ” Get Azure SQL Connection String
        id: get-connection
        run: |
          # Get SQL Server details
          SQL_SERVER=$(az sql server list --resource-group casezero-shared-${{ github.event.inputs.environment }}-rg --query "[0].fullyQualifiedDomainName" -o tsv)
          SQL_DATABASE="casezero-db"
          SQL_USER="${{ secrets.SQL_ADMIN_LOGIN }}"
          SQL_PASSWORD="${{ secrets.SQL_ADMIN_PASSWORD }}"
          
          # Build connection string
          CONNECTION_STRING="Server=tcp:${SQL_SERVER},1433;Initial Catalog=${SQL_DATABASE};Persist Security Info=False;User ID=${SQL_USER};Password=${SQL_PASSWORD};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
          
          echo "::add-mask::${CONNECTION_STRING}"
          echo "CONNECTION_STRING=${CONNECTION_STRING}" >> $GITHUB_OUTPUT
          echo "âœ… Connection string configured"

      - name: ðŸ—„ï¸ Apply Database Migrations
        if: github.event.inputs.action == 'migrate' || github.event.inputs.action == 'migrate-and-seed'
        working-directory: backend/CaseZeroApi
        env:
          ConnectionStrings__DefaultConnection: ${{ steps.get-connection.outputs.CONNECTION_STRING }}
        run: |
          echo "ðŸ”„ Applying EF Core migrations to Azure SQL..."
          dotnet ef database update --project CaseZeroApi.csproj --no-build --verbose
          echo "âœ… Migrations applied successfully"

      - name: ðŸŒ± Seed Database
        if: github.event.inputs.action == 'seed' || github.event.inputs.action == 'migrate-and-seed'
        working-directory: backend/CaseZeroApi
        env:
          ConnectionStrings__DefaultConnection: ${{ steps.get-connection.outputs.CONNECTION_STRING }}
          ASPNETCORE_ENVIRONMENT: ${{ github.event.inputs.environment == 'prod' && 'Production' || 'Development' }}
        run: |
          echo "ðŸŒ± Seeding database..."
          # Run a custom seeding command or endpoint
          # Option 1: Run the app temporarily to seed via startup
          # Option 2: Create a dedicated seeding console app
          # Option 3: Use SQL scripts
          
          # For now, we'll build and run the seeding logic
          dotnet run --project CaseZeroApi.csproj -- --seed-only
          echo "âœ… Database seeded successfully"

      - name: ðŸ“Š Verify Database Schema
        run: |
          echo "ðŸ“Š Verifying database schema..."
          az sql db show \
            --resource-group casezero-shared-${{ github.event.inputs.environment }}-rg \
            --server $(az sql server list --resource-group casezero-shared-${{ github.event.inputs.environment }}-rg --query "[0].name" -o tsv) \
            --name casezero-db \
            --query "{Name:name, Status:status, Edition:edition, MaxSizeBytes:maxSizeBytes}" \
            -o table
          echo "âœ… Database verification complete"

      - name: ðŸŽ¯ Summary
        if: always()
        run: |
          echo "## ðŸ—„ï¸ Database Migration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.action }}" == "migrate" ] || [ "${{ github.event.inputs.action }}" == "migrate-and-seed" ]; then
            echo "âœ… Database migrations applied" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event.inputs.action }}" == "seed" ] || [ "${{ github.event.inputs.action }}" == "migrate-and-seed" ]; then
            echo "âœ… Database seeded" >> $GITHUB_STEP_SUMMARY
          fi
