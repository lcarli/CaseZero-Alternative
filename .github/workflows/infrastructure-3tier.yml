name: ğŸ—ï¸ Deploy 3-Tier Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Action to perform'
        required: true
        type: choice
        default: 'deploy'
        options:
          - validate
          - deploy
          - destroy
      deploy_sql_database:
        description: 'Deploy Azure SQL Database'
        required: true
        type: boolean
        default: false
      confirm_destroy:
        description: 'Type "CONFIRM" to destroy resources'
        required: false
        default: ''

env:
  BICEP_FILE_PATH: infrastructure/main.bicep

jobs:
  validate-inputs:
    name: âœ… Validate Inputs
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Validate destroy confirmation
        if: github.event.inputs.action == 'destroy'
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "CONFIRM" ]; then
            echo "âŒ Destroy action requires typing 'CONFIRM'"
            exit 1
          fi
          echo "âœ… Destroy action confirmed"

  validate-bicep:
    name: ğŸ” Validate Bicep Templates
    runs-on: ubuntu-latest
    needs: [validate-inputs]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ github.event.inputs.environment == 'prod' && secrets.AZURE_CREDENTIALS_PROD || secrets.AZURE_CREDENTIALS_DEV }}

      - name: ğŸ” Validate Bicep syntax
        run: |
          echo "Validating Bicep template syntax..."
          az bicep build --file ${{ env.BICEP_FILE_PATH }}

      - name: ğŸ” Validate deployment
        run: |
          PARAMS_FILE="infrastructure/parameters.${{ github.event.inputs.environment }}.json"
          
          echo "Validating subscription-level deployment..."
          az deployment sub validate \
            --location canadacentral \
            --template-file ${{ env.BICEP_FILE_PATH }} \
            --parameters @$PARAMS_FILE \
            --parameters sqlAdminLogin='${{ secrets.SQL_ADMIN_LOGIN }}' \
            --parameters sqlAdminPassword='${{ secrets.SQL_ADMIN_PASSWORD }}'

      - name: ğŸ“Š Generate What-If Analysis
        if: github.event.inputs.action != 'validate'
        run: |
          PARAMS_FILE="infrastructure/parameters.${{ github.event.inputs.environment }}.json"
          
          echo "Generating What-If analysis..."
          az deployment sub what-if \
            --location canadacentral \
            --template-file ${{ env.BICEP_FILE_PATH }} \
            --parameters @$PARAMS_FILE \
            --parameters sqlAdminLogin='${{ secrets.SQL_ADMIN_LOGIN }}' \
            --parameters sqlAdminPassword='${{ secrets.SQL_ADMIN_PASSWORD }}' \
            --result-format FullResourcePayloads

  deploy-infrastructure:
    name: ğŸ—ï¸ Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [validate-bicep]
    if: github.event.inputs.action == 'deploy'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ github.event.inputs.environment == 'prod' && secrets.AZURE_CREDENTIALS_PROD || secrets.AZURE_CREDENTIALS_DEV }}

      - name: ğŸš€ Deploy Infrastructure
        id: deploy
        run: |
          PARAMS_FILE="infrastructure/parameters.${{ github.event.inputs.environment }}.json"
          DEPLOYMENT_NAME="casezero-${{ github.event.inputs.environment }}-$(date +%Y%m%d-%H%M%S)"
          
          echo "Deploying infrastructure: $DEPLOYMENT_NAME"
          
          az deployment sub create \
            --name $DEPLOYMENT_NAME \
            --location canadacentral \
            --template-file ${{ env.BICEP_FILE_PATH }} \
            --parameters @$PARAMS_FILE \
            --parameters enableSqlDatabase=${{ github.event.inputs.deploy_sql_database }} \
            --parameters sqlAdminLogin='${{ secrets.SQL_ADMIN_LOGIN }}' \
            --parameters sqlAdminPassword='${{ secrets.SQL_ADMIN_PASSWORD }}' \
            --output json > deployment-output.json
          
          cat deployment-output.json

      - name: ğŸ“¤ Upload Deployment Output
        uses: actions/upload-artifact@v4
        with:
          name: deployment-output-${{ github.event.inputs.environment }}
          path: deployment-output.json

      - name: ğŸ“ Extract Outputs
        id: outputs
        run: |
          echo "Extracting deployment outputs..."
          
          FRONTEND_URL=$(jq -r '.properties.outputs.staticWebAppUrl.value' deployment-output.json)
          API_URL=$(jq -r '.properties.outputs.apiAppServiceUrl.value' deployment-output.json)
          FUNCTIONS_URL=$(jq -r '.properties.outputs.functionAppUrl.value' deployment-output.json)
          
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "functions_url=$FUNCTIONS_URL" >> $GITHUB_OUTPUT
          
          echo "âœ… Deployment complete!"
          echo "ğŸ“± Frontend URL: $FRONTEND_URL"
          echo "ğŸ”Œ API URL: $API_URL"
          echo "âš¡ Functions URL: $FUNCTIONS_URL"

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ—ï¸ Infrastructure Deployment Complete\n\n**Environment**: ${{ github.event.inputs.environment }}\n\n**URLs**:\n- ğŸ“± Frontend: ${{ steps.outputs.outputs.frontend_url }}\n- ğŸ”Œ API: ${{ steps.outputs.outputs.api_url }}\n- âš¡ Functions: ${{ steps.outputs.outputs.functions_url }}`
            })

  destroy-infrastructure:
    name: ğŸ—‘ï¸ Destroy Infrastructure
    runs-on: ubuntu-latest
    needs: [validate-bicep]
    if: github.event.inputs.action == 'destroy'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ github.event.inputs.environment == 'prod' && secrets.AZURE_CREDENTIALS_PROD || secrets.AZURE_CREDENTIALS_DEV }}

      - name: ğŸ—‘ï¸ Delete Resource Groups
        run: |
          ENV="${{ github.event.inputs.environment }}"
          PREFIX="casezero"
          
          echo "âš ï¸ Destroying all resource groups for environment: $ENV"
          
          # List resource groups to delete
          RESOURCE_GROUPS=$(az group list --query "[?tags.Environment=='$ENV' && starts_with(name, '$PREFIX')].name" -o tsv)
          
          echo "Resource groups to delete:"
          echo "$RESOURCE_GROUPS"
          
          # Delete each resource group
          for RG in $RESOURCE_GROUPS; do
            echo "Deleting resource group: $RG"
            az group delete --name $RG --yes --no-wait
          done
          
          echo "âœ… Deletion initiated for all resource groups"

      - name: ğŸ“ Wait for Deletion
        run: |
          echo "â³ Waiting for resource groups to be deleted..."
          sleep 60
          
          ENV="${{ github.event.inputs.environment }}"
          PREFIX="casezero"
          
          # Check if any resource groups still exist
          REMAINING=$(az group list --query "[?tags.Environment=='$ENV' && starts_with(name, '$PREFIX')].name" -o tsv)
          
          if [ -z "$REMAINING" ]; then
            echo "âœ… All resource groups deleted successfully"
          else
            echo "âš ï¸ Some resource groups are still being deleted:"
            echo "$REMAINING"
            echo "Check Azure Portal for status"
          fi
